<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nūhou - Hawaii News</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,wght@0,400;0,600;0,700;1,400&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Source Sans 3', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fafaf8;
      color: #1a1a1a;
      line-height: 1.5;
    }
    
    .header {
      background: linear-gradient(135deg, #2d5a27 0%, #1e3d1a 100%);
      color: white;
      padding: 1rem 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    .header h1 {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 2rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }
    
    .header-subtitle {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 0.25rem;
    }
    
    .tags-bar {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .tags-bar-label {
      font-size: 0.8rem;
      opacity: 0.8;
      margin-right: 0.5rem;
    }
    
    .tag-btn {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 0.3rem 0.7rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    
    .tag-btn:hover { background: rgba(255,255,255,0.25); }
    .tag-btn.active { background: white; color: #2d5a27; font-weight: 600; }
    
    .search-box {
      margin-top: 1rem;
    }
    
    .search-box input {
      width: 100%;
      max-width: 400px;
      padding: 0.6rem 1rem;
      border: none;
      border-radius: 4px;
      font-size: 0.95rem;
    }
    
    .main {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .stories { display: flex; flex-direction: column; gap: 1.5rem; }
    
    .lead-story {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      position: relative;
    }
    
    .story-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.5rem;
    }
    
    .lead-story h2 {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 600;
      line-height: 1.3;
      flex: 1;
    }
    
    .lead-story h2 a {
      color: #1a1a1a;
      text-decoration: none;
    }
    
    .lead-story h2 a:hover { color: #2d5a27; }
    
    .story-meta {
      font-size: 0.85rem;
      color: #666;
      margin-bottom: 0.75rem;
    }
    
    .story-description {
      color: #444;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }
    
    .related-coverage {
      border-top: 1px solid #eee;
      padding-top: 1rem;
    }
    
    .related-coverage h4 {
      font-size: 0.8rem;
      color: #888;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    
    .related-list {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    
    .related-item {
      font-size: 0.9rem;
    }
    
    .related-item a {
      color: #2d5a27;
      text-decoration: none;
    }
    
    .related-item a:hover { text-decoration: underline; }
    
    .related-source {
      color: #888;
      font-size: 0.8rem;
    }
    
    .loading {
      text-align: center;
      padding: 3rem;
      color: #666;
    }
    
    .error {
      background: #fee;
      color: #c00;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
    }
    
    /* Tag display and editing */
    .story-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: #e8f0e8;
      color: #2d5a27;
      padding: 0.2rem 0.6rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 0.5rem;
      flex-shrink: 0;
    }
    
    .story-tag:hover {
      background: #d0e0d0;
    }
    
    .story-tag.override {
      background: #fff3e0;
      color: #e65100;
    }
    
    .story-tag .edit-icon {
      font-size: 0.7rem;
      opacity: 0.7;
    }
    
    .tag-editor {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 100;
      min-width: 200px;
    }
    
    .tag-editor h4 {
      font-size: 0.85rem;
      margin-bottom: 0.75rem;
      color: #333;
    }
    
    .tag-editor input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      margin-bottom: 0.75rem;
    }
    
    .tag-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-bottom: 0.75rem;
    }
    
    .tag-suggestion {
      background: #f0f0f0;
      border: none;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tag-suggestion:hover {
      background: #e0e0e0;
    }
    
    .tag-editor-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .tag-editor-buttons button {
      flex: 1;
      padding: 0.4rem;
      border: none;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    
    .tag-editor-buttons .save-btn {
      background: #2d5a27;
      color: white;
    }
    
    .tag-editor-buttons .cancel-btn {
      background: #f0f0f0;
      color: #333;
    }
    
    .tag-editor-buttons .reset-btn {
      background: #fee;
      color: #c00;
      font-size: 0.7rem;
    }
    
    .stats {
      font-size: 0.8rem;
      color: #888;
      text-align: center;
      padding: 1rem;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;
    
    const API_BASE = '/api';
    
    function formatTime(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor(diff / (1000 * 60));
      
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      return date.toLocaleDateString();
    }
    
    function TagEditor({ storyId, currentTag, allTags, onSave, onCancel, onReset, isOverride }) {
      const [newTag, setNewTag] = useState(currentTag);
      const inputRef = useRef(null);
      
      useEffect(() => {
        inputRef.current?.focus();
      }, []);
      
      const handleSave = () => {
        if (newTag.trim()) {
          onSave(storyId, newTag.trim().toLowerCase());
        }
      };
      
      const handleKeyDown = (e) => {
        if (e.key === 'Enter') handleSave();
        if (e.key === 'Escape') onCancel();
      };
      
      const suggestions = allTags.filter(t => t !== 'all' && t !== currentTag).slice(0, 6);
      
      return (
        <div className="tag-editor" onClick={e => e.stopPropagation()}>
          <h4>Change Tag</h4>
          <input
            ref={inputRef}
            type="text"
            value={newTag}
            onChange={e => setNewTag(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="Enter tag name..."
          />
          {suggestions.length > 0 && (
            <div className="tag-suggestions">
              {suggestions.map(tag => (
                <button
                  key={tag}
                  className="tag-suggestion"
                  onClick={() => setNewTag(tag)}
                >
                  {tag}
                </button>
              ))}
            </div>
          )}
          <div className="tag-editor-buttons">
            <button className="cancel-btn" onClick={onCancel}>Cancel</button>
            <button className="save-btn" onClick={handleSave}>Save</button>
          </div>
          {isOverride && (
            <button 
              className="reset-btn" 
              style={{width: '100%', marginTop: '0.5rem'}}
              onClick={() => onReset(storyId)}
            >
              Reset to auto-detected
            </button>
          )}
        </div>
      );
    }
    
    function StoryCluster({ cluster, allTags, onTagUpdate, onTagReset }) {
      const [editing, setEditing] = useState(false);
      const lead = cluster.lead || cluster.articles?.[0];
      const related = cluster.articles?.slice(1) || [];
      
      if (!lead) return null;
      
      const handleTagClick = (e) => {
        e.preventDefault();
        e.stopPropagation();
        setEditing(true);
      };
      
      const handleSave = async (storyId, newTag) => {
        await onTagUpdate(storyId, newTag);
        setEditing(false);
      };
      
      const handleReset = async (storyId) => {
        await onTagReset(storyId);
        setEditing(false);
      };
      
      return (
        <article className="lead-story">
          <div className="story-header">
            <h2>
              <a href={lead.link} target="_blank" rel="noopener noreferrer">
                {lead.title}
              </a>
            </h2>
            <span 
              className={`story-tag ${cluster.tagOverride ? 'override' : ''}`}
              onClick={handleTagClick}
              title="Click to change tag"
            >
              {cluster.tag || 'general'}
              <span className="edit-icon">✎</span>
            </span>
          </div>
          
          {editing && (
            <TagEditor
              storyId={cluster.id}
              currentTag={cluster.tag || 'general'}
              allTags={allTags}
              onSave={handleSave}
              onCancel={() => setEditing(false)}
              onReset={handleReset}
              isOverride={cluster.tagOverride}
            />
          )}
          
          <div className="story-meta">
            <strong>{lead.source}</strong> • {formatTime(lead.pubDate)}
          </div>
          {lead.description && (
            <p className="story-description">
              {lead.description.slice(0, 250)}
              {lead.description.length > 250 ? '...' : ''}
            </p>
          )}
          {related.length > 0 && (
            <div className="related-coverage">
              <h4>Also covering ({related.length})</h4>
              <div className="related-list">
                {related.slice(0, 5).map((article, i) => (
                  <div key={i} className="related-item">
                    <a href={article.link} target="_blank" rel="noopener noreferrer">
                      {article.title.slice(0, 80)}{article.title.length > 80 ? '...' : ''}
                    </a>
                    <span className="related-source"> — {article.source}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </article>
      );
    }
    
    function App() {
      const [stories, setStories] = useState([]);
      const [tags, setTags] = useState(['all']);
      const [selectedTag, setSelectedTag] = useState('all');
      const [search, setSearch] = useState('');
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      const [stats, setStats] = useState(null);
      
      const fetchStories = useCallback(async () => {
        try {
          setLoading(true);
          setError(null);
          
          let url = `${API_BASE}/stories`;
          const params = new URLSearchParams();
          if (selectedTag !== 'all') params.set('tag', selectedTag);
          if (search) params.set('search', search);
          if (params.toString()) url += `?${params}`;
          
          const res = await fetch(url);
          if (!res.ok) throw new Error('Failed to fetch stories');
          const data = await res.json();
          setStories(data.stories || []);
          if (data.tags) setTags(data.tags);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      }, [selectedTag, search]);
      
      const fetchStats = useCallback(async () => {
        try {
          const res = await fetch(`${API_BASE}/stats`);
          if (res.ok) {
            const data = await res.json();
            setStats(data);
          }
        } catch (err) {
          console.error('Failed to fetch stats:', err);
        }
      }, []);
      
      const updateTag = async (storyId, newTag) => {
        try {
          const res = await fetch(`${API_BASE}/stories/${storyId}/tag`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tag: newTag })
          });
          
          if (res.ok) {
            fetchStories(); // Refresh to show updated tags
          }
        } catch (err) {
          console.error('Failed to update tag:', err);
        }
      };
      
      const resetTag = async (storyId) => {
        try {
          const res = await fetch(`${API_BASE}/stories/${storyId}/tag`, {
            method: 'DELETE'
          });
          
          if (res.ok) {
            fetchStories();
          }
        } catch (err) {
          console.error('Failed to reset tag:', err);
        }
      };
      
      useEffect(() => {
        fetchStories();
      }, [fetchStories]);
      
      useEffect(() => {
        fetchStats();
        const interval = setInterval(fetchStats, 60000);
        return () => clearInterval(interval);
      }, [fetchStats]);
      
      const handleSearch = (e) => {
        e.preventDefault();
        fetchStories();
      };
      
      return (
        <div>
          <header className="header">
            <h1>Nūhou</h1>
            <div className="header-subtitle">Hawaii News Aggregator</div>
            
            <div className="tags-bar">
              <span className="tags-bar-label">Filter by tag:</span>
              {tags.map(tag => (
                <button
                  key={tag}
                  className={`tag-btn ${selectedTag === tag ? 'active' : ''}`}
                  onClick={() => setSelectedTag(tag)}
                >
                  {tag}
                </button>
              ))}
            </div>
            
            <form className="search-box" onSubmit={handleSearch}>
              <input
                type="text"
                placeholder="Search Hawaii news..."
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
            </form>
          </header>
          
          <main className="main">
            <div className="stories">
              {loading && <div className="loading">Loading stories...</div>}
              {error && <div className="error">{error}</div>}
              {!loading && !error && stories.length === 0 && (
                <div className="loading">No stories found. Feeds are being fetched...</div>
              )}
              {stories.map((cluster, i) => (
                <StoryCluster 
                  key={cluster.id || i} 
                  cluster={cluster} 
                  allTags={tags}
                  onTagUpdate={updateTag}
                  onTagReset={resetTag}
                />
              ))}
              {stats && (
                <div className="stats">
                  {stats.articleCount || 0} articles from {stats.sourceCount || 0} sources
                  <br />
                  Last updated: {stats.lastRefresh ? formatTime(stats.lastRefresh) : 'Never'}
                </div>
              )}
            </div>
          </main>
        </div>
      );
    }
    
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
